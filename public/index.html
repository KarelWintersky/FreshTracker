<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="VERSION_PLACEHOLDER">
    <title>FreshTracker - –£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</title>
    <link rel="stylesheet" href="assets/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .main-content {
            padding: 30px;
            min-height: 600px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.5em;
            margin: 0;
        }

        .add-product-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            white-space: nowrap;
        }

        .add-product-btn:hover {
            transform: translateY(-2px);
            background: #218838;
        }

        .form-panel {
            position: fixed;
            top: -100%;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            padding: 30px;
            transition: top 0.8s ease;
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-panel.active {
            top: 45%;
            transform: translate(-50%, -50%);
        }

        .close-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-panel:hover {
            background: #f8f9fa;
            color: #dc3545;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .products-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .product-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
            transition: background-color 0.3s;
        }

        .product-item:hover {
            background-color: #f8f9fa;
        }

        .product-item.header {
            background: #2c3e50;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .expired {
            background-color: #ffe6e6;
            border-left: 4px solid #dc3545;
        }

        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-ok { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-expired { background-color: #dc3545; }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .input-with-prefix {
            position: relative;
        }

        .input-prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-weight: 600;
        }

        .input-with-prefix input {
            padding-left: 40px;
        }

        .quick-days-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .quick-days-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background-color 0.3s;
            flex: 1;
            min-width: 50px;
        }

        .quick-days-btn:hover {
            background: #5a6268;
        }

        .quick-days-btn.active {
            background: #667eea;
        }

        .threshold-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .threshold-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background-color 0.3s;
            flex: 1;
            min-width: 50px;
        }

        .threshold-btn:hover {
            background: #138496;
        }

        .threshold-btn.active {
            background: #667eea;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .panel-title {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.5em;
        }

        .default-expiry-hint {
            font-size: 12px;
            color: #28a745;
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .product-item {
                grid-template-columns: 1fr;
                gap: 8px;
                text-align: center;
            }

            .product-item.header {
                display: none;
            }

            .product-item div::before {
                content: attr(data-label);
                font-weight: bold;
                display: block;
                margin-bottom: 5px;
                color: #6c757d;
            }
        }
    </style>
</head>
<body>
<div class="overlay" id="overlay"></div>

<div class="container">
    <div class="header">
        <h1>üçé FreshTracker</h1>
        <p>–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–æ–∫–æ–≤ –≥–æ–¥–Ω–æ—Å—Ç–∏</p>
    </div>

    <div class="main-content">
        <div class="section-header">
            <h2 class="section-title">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h2>
            <button class="add-product-btn" onclick="openFormPanel()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
        </div>

        <div class="product-item header">
            <div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
            <div>–í–µ—Å</div>
            <div>–¢–∏–ø</div>
            <div>–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</div>
            <div>–°—Ç–∞—Ç—É—Å</div>
            <div>–î–µ–π—Å—Ç–≤–∏–µ</div>
        </div>

        <div id="productsList" class="products-list">
            <div class="empty-state">
                <i>üì¶</i>
                <p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>
                <button class="btn" onclick="openFormPanel()" style="width: auto; margin-top: 20px;">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç</button>
            </div>
        </div>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ -->
<div class="form-panel" id="formPanel">
    <button class="close-panel" onclick="closeFormPanel()">√ó</button>
    <h3 class="panel-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>

    <form id="productForm">
        <div class="form-group">
            <label for="name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
            <input type="text" id="name" name="name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì—Ä–µ—á–Ω–µ–≤–∞—è –∫—Ä—É–ø–∞">
        </div>

        <div class="form-group">
            <label for="type">–¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞</label>
            <select id="type" name="type" required onchange="updateDefaultsByType()">
                <option value="—Ä–∞–∑–Ω–æ–µ" selected>–†–∞–∑–Ω–æ–µ</option>
                <option value="–∫—Ä—É–ø—ã">–ö—Ä—É–ø—ã</option>
                <option value="–º–∞–∫–∞—Ä–æ–Ω—ã">–ú–∞–∫–∞—Ä–æ–Ω—ã</option>
                <option value="–∫–æ–Ω—Å–µ—Ä–≤—ã">–ö–æ–Ω—Å–µ—Ä–≤—ã</option>
                <option value="–º–∞—Å–ª–æ">–ú–∞—Å–ª–æ</option>
                <option value="–º—É–∫–∞">–ú—É–∫–∞</option>
                <option value="—Å–ø–µ—Ü–∏–∏">–°–ø–µ—Ü–∏–∏</option>
                <option value="—á–∞–π_–∫–æ—Ñ–µ">–ß–∞–π/–ö–æ—Ñ–µ</option>
            </select>
            <div class="default-expiry-hint" id="expiryHint"></div>
        </div>

        <div class="form-group">
            <label for="weight">–í–µ—Å</label>
            <div class="input-with-prefix">
                <span class="input-prefix">‚öñÔ∏è</span>
                <input type="number" id="weight" name="weight" step="0.001" required placeholder="0.5">
            </div>
        </div>

        <div class="form-group">
            <label for="expiry_date">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</label>
            <input type="text" id="expiry_date" name="expiry_date" required
                   placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ">

            <div class="quick-days-buttons">
                <button type="button" class="quick-days-btn" onclick="setDays(3)">+3 –¥–Ω</button>
                <button type="button" class="quick-days-btn" onclick="setDays(7)">+7 –¥–Ω</button>
                <button type="button" class="quick-days-btn" onclick="setDays(14)">+14 –¥–Ω</button>
                <button type="button" class="quick-days-btn" onclick="setDays(30)">+30 –¥–Ω</button>
                <button type="button" class="quick-days-btn" onclick="setDays(60)">+60 –¥–Ω</button>
                <button type="button" class="quick-days-btn" id="defaultExpiryBtn" onclick="setDefaultExpiry()" style="background: #28a745;">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
            </div>
        </div>

        <div class="form-group">
            <label for="threshold_days">–ü–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–¥–Ω–∏)</label>
            <div class="input-with-prefix">
                <span class="input-prefix">‚è∞</span>
                <input type="number" id="threshold_days" name="threshold_days" value="7" min="1" max="365">
            </div>

            <div class="threshold-buttons">
                <button type="button" class="threshold-btn" onclick="setThreshold(3)">3 –¥–Ω</button>
                <button type="button" class="threshold-btn" onclick="setThreshold(7)">7 –¥–Ω</button>
                <button type="button" class="threshold-btn" onclick="setThreshold(14)">14 –¥–Ω</button>
                <button type="button" class="threshold-btn" onclick="setThreshold(30)">30 –¥–Ω</button>
            </div>
        </div>

        <button type="submit" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<script>
    const API_URL = 'freshtracker.php';
    let datePicker;

    // –í–µ—Å–∞ –ø–æ —Ç–∏–ø–∞–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    const typeWeights = {
        '—Ä–∞–∑–Ω–æ–µ': '1.0',
        '–∫—Ä—É–ø—ã': '0.9',
        '–º–∞–∫–∞—Ä–æ–Ω—ã': '0.5',
        '–∫–æ–Ω—Å–µ—Ä–≤—ã': '0.4',
        '–º–∞—Å–ª–æ': '0.9',
        '–º—É–∫–∞': '1.0',
        '—Å–ø–µ—Ü–∏–∏': '0.1',
        '—á–∞–π_–∫–æ—Ñ–µ': '0.25'
    };

    // –°—Ä–æ–∫–∏ –≥–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–∏–ø–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–≤ –¥–Ω—è—Ö)
    const defaultExpiryDays = {
        '—Ä–∞–∑–Ω–æ–µ': 30,
        '–∫—Ä—É–ø—ã': 365,
        '–º–∞–∫–∞—Ä–æ–Ω—ã': 180,
        '–∫–æ–Ω—Å–µ—Ä–≤—ã': 365,
        '–º–∞—Å–ª–æ': 30,
        '–º—É–∫–∞': 365,
        '—Å–ø–µ—Ü–∏–∏': 180,
        '—á–∞–π_–∫–æ—Ñ–µ': 180
    };

    // –û–ø–∏—Å–∞–Ω–∏—è —Å—Ä–æ–∫–æ–≤ –≥–æ–¥–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
    const expiryDescriptions = {
        '—Ä–∞–∑–Ω–æ–µ': '30 –¥–Ω–µ–π',
        '–∫—Ä—É–ø—ã': '1 –≥–æ–¥',
        '–º–∞–∫–∞—Ä–æ–Ω—ã': '6 –º–µ—Å—è—Ü–µ–≤',
        '–∫–æ–Ω—Å–µ—Ä–≤—ã': '1 –≥–æ–¥',
        '–º–∞—Å–ª–æ': '1 –º–µ—Å—è—Ü',
        '–º—É–∫–∞': '1 –≥–æ–¥',
        '—Å–ø–µ—Ü–∏–∏': '6 –º–µ—Å—è—Ü–µ–≤',
        '—á–∞–π_–∫–æ—Ñ–µ': '6 –º–µ—Å—è—Ü–µ–≤'
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
        initDatePicker();
        updateExpiryHint();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addProduct();
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
        document.getElementById('overlay').addEventListener('click', closeFormPanel);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFormPanel();
            }
        });
    });

    function openFormPanel() {
        document.getElementById('formPanel').classList.add('active');
        document.getElementById('overlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeFormPanel() {
        document.getElementById('formPanel').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    function initDatePicker() {
        datePicker = flatpickr("#expiry_date", {
            locale: "ru",
            dateFormat: "d.m.Y",
            altInput: true,
            altFormat: "d.m.Y",
            minDate: "today",
            allowInput: true,
            clickOpens: true
        });
    }

    function updateDefaultsByType() {
        updateWeightByType();
        updateExpiryHint();
    }

    function updateWeightByType() {
        const type = document.getElementById('type').value;
        const weightInput = document.getElementById('weight');

        if (typeWeights[type]) {
            weightInput.value = typeWeights[type];
        }
    }

    function updateExpiryHint() {
        const type = document.getElementById('type').value;
        const hintElement = document.getElementById('expiryHint');

        if (expiryDescriptions[type]) {
            hintElement.textContent = `–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${expiryDescriptions[type]}`;
        } else {
            hintElement.textContent = '';
        }
    }

    function setDefaultExpiry() {
        const type = document.getElementById('type').value;
        const days = defaultExpiryDays[type] || 30;

        const today = new Date();
        today.setDate(today.getDate() + days);
        datePicker.setDate(today);

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é"
        document.querySelectorAll('.quick-days-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById('defaultExpiryBtn').classList.add('active');
    }

    function setDays(days) {
        const today = new Date();
        today.setDate(today.getDate() + days);
        datePicker.setDate(today);

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.quick-days-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    function setThreshold(days) {
        document.getElementById('threshold_days').value = days;

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.threshold-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    function loadProducts() {
        const formData = new FormData();
        formData.append('action', 'get_list');

        fetch(API_URL, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(products => {
                displayProducts(products);
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                const container = document.getElementById('productsList');
                container.innerHTML = `
                <div class="empty-state">
                    <i>‚ö†Ô∏è</i>
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                    <button class="btn" onclick="loadProducts()" style="width: auto; margin-top: 20px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                </div>
            `;
            });
    }

    function displayProducts(products) {
        const container = document.getElementById('productsList');

        if (!products || !Array.isArray(products) || products.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
                <i>üì¶</i>
                <p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>
                <button class="btn" onclick="openFormPanel()" style="width: auto; margin-top: 20px;">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç</button>
            </div>
        `;
            return;
        }

        container.innerHTML = '';

        products.forEach(product => {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const productId = parseInt(product.id) || 0;
            const productName = escapeHtml(product.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
            const productWeight = parseFloat(product.weight) || 0;
            const productType = escapeHtml(product.type || '—Ä–∞–∑–Ω–æ–µ');
            const expiryDate = product.expiry_date || '';
            const thresholdDays = parseInt(product.threshold_days) || 7;
            const daysRemaining = parseFloat(product.days_remaining) || 0;

            let statusClass = '';
            let statusText = '';
            let statusIcon = '';

            if (daysRemaining < 0) {
                statusClass = 'expired';
                statusText = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω';
                statusIcon = 'status-expired';
            } else if (daysRemaining <= thresholdDays) {
                statusClass = 'warning';
                statusText = `–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç <br>&nbsp;&nbsp;&nbsp;&nbsp; (–æ—Å—Ç–∞–ª–æ—Å—å ${Math.ceil(daysRemaining)} –¥–Ω.)`;
                statusIcon = 'status-warning';
            } else {
                statusText = `–û–ö (${Math.ceil(daysRemaining)} –¥–Ω.)`;
                statusIcon = 'status-ok';
            }

            const productElement = document.createElement('div');
            productElement.className = `product-item ${statusClass}`;

            productElement.innerHTML = `
            <div data-label="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"><strong>${productName}</strong></div>
            <div data-label="–í–µ—Å">${productWeight} –∫–≥</div>
            <div data-label="–¢–∏–ø">${productType}</div>
            <div data-label="–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏">${formatDate(expiryDate)}</div>
            <div data-label="–°—Ç–∞—Ç—É—Å"><span class="status-indicator ${statusIcon}"></span>${statusText}</div>
            <div data-label="–î–µ–π—Å—Ç–≤–∏–µ">
                <button class="delete-btn" onclick="deleteProduct(${productId})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `;

            container.appendChild(productElement);
        });
    }

    function addProduct() {
        const form = document.getElementById('productForm');
        const formData = new FormData(form);
        formData.append('action', 'add');

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        const name = formData.get('name');
        const weight = parseFloat(formData.get('weight'));

        if (!name || !name.trim()) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞', 'error');
            return;
        }

        if (!weight || weight <= 0) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å', 'error');
            return;
        }

        fetch(API_URL, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    form.reset();
                    document.getElementById('type').value = '—Ä–∞–∑–Ω–æ–µ';
                    document.getElementById('weight').value = '1.0';
                    document.getElementById('threshold_days').value = '7';
                    if (datePicker) {
                        datePicker.clear();
                    }
                    updateExpiryHint();

                    document.querySelectorAll('.quick-days-btn, .threshold-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    closeFormPanel();
                    loadProducts();
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏', 'error');
            });
    }

    function deleteProduct(id) {
        if (!id || id <= 0) {
            showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π ID –ø—Ä–æ–¥—É–∫—Ç–∞', 'error');
            return;
        }

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç?')) {
            return;
        }

        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('id', id);

        fetch(API_URL, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    loadProducts();
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
            });
    }

    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return '–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞';
            }
            return date.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', error);
            return '–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞';
        }
    }

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') {
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å—Ç—Ä–æ–∫–∞, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É
            unsafe = String(unsafe);
        }

        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        setTimeout(() => {
            notification.style.transform = 'translateX(400px)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
</script>
</body>
</html>