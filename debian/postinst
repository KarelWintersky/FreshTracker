#!/bin/sh

set -e

WWW_ROOT=/var/www/freshtracker/

# Функция для получения пользователя из nginx.conf
get_nginx_user() {
    local nginx_conf="/etc/nginx/nginx.conf"
    local default_user="www-data"

    # Если файл не существует, сразу возвращаем пользователя по умолчанию
    if [ ! -f "$nginx_conf" ]; then
        echo "$default_user"
        return 0
    fi

    # Если файл существует, пытаемся извлечь пользователя
    if [ -f "$nginx_conf" ]; then
        local nginx_user=$(grep -E '^\s*user\s+' "$nginx_conf" | head -1 | awk '{print $2}' | tr -d ';' 2>/dev/null || true)

        if [ -n "$nginx_user" ]; then
            echo "$nginx_user"
            return 0
        fi
    fi

    # В любом другом случае используем www-data
    echo "$default_user"
}

case "$1" in
    configure)
      if [ -d "$WWW_ROOT" ]; then
        # Получаем пользователя (всегда будет www-data если nginx.conf нет)
        NGINX_USER=$(get_nginx_user)

        # Устанавливаем владельца
        chown -R "$NGINX_USER":"$NGINX_USER" "$WWW_ROOT"/

        # Устанавливаем права
        find "$WWW_ROOT" -type f -exec chmod 644 {} \;
        find "$WWW_ROOT" -type d -exec chmod 755 {} \;

        exit 0
      fi

      echo "postinst can't find path: $WWW_ROOT!" >&2
      exit 1
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        # Ничего не делаем в этих случаях
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

#DEBHELPER#

exit 0